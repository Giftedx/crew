groups:
  - name: crew-observability
    interval: 30s
    rules:
      - alert: HighSemanticCachePromotionRateDrop
        expr: |
          (avg_over_time(semantic_cache_shadow_hit_ratio[15m]) < 0.2)
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Semantic cache shadow hit ratio low"
          description: "Shadow hit ratio below 20% for 10m. Investigate cache health and similarity thresholds."

      - alert: IngestConcurrencyFallbackSpike
        expr: |
          increase(degradation_events_total{component="ingest",event_type="concurrency_executor_failure"}[10m]) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Ingest concurrency fallbacks spiking"
          description: "More than 5 concurrency executor failures in the last 10m."

      - alert: AgentEvalsFallbackFrequent
        expr: |
          increase(degradation_events_total{component="trajectory_eval",event_type="agent_evals_fallback"}[30m]) > 10
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "AgentEvals fallback frequent"
          description: "AgentEvals adapter falling back frequently over 30m."

      - alert: LanggraphPilotFallbackPersistent
        expr: |
          increase(degradation_events_total{component="langgraph_pilot",event_type="fallback_sequential"}[30m]) > 20
        for: 15m
        labels:
          severity: info
        annotations:
          summary: "LangGraph pilot fallback persistent"
          description: "Pilot is consistently falling back to sequential execution."

      - alert: LanggraphPilotStepFailuresSpike
        expr: |
          sum(increase(degradation_events_total{component="langgraph_pilot",event_type=~"segment_failure|embed_failure"}[10m])) > 5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "LangGraph pilot step failures spiking"
          description: "Segment or embed failures exceeded threshold in the last 10m."

      - alert: LanggraphPilotSlowDuration
        expr: |
          (
            sum(rate(pipeline_duration_seconds_sum{status="success"}[10m])) / sum(rate(pipeline_duration_seconds_count{status="success"}[10m]))
          ) > 5
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "LangGraph pilot slow average duration"
          description: "Average pilot pipeline duration over the last 10m is >5s."

      - alert: LanggraphPilotHighErrorRatio
        expr: |
          (
            sum(rate(pipeline_duration_seconds_count{status="error"}[10m]))
            /
            sum(rate(pipeline_duration_seconds_count[10m]))
          ) > 0.05
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "LangGraph pilot high error ratio"
          description: "More than 5% of pilot runs are erroring over the last 10 minutes."

      - alert: LanggraphPilotIngestStepSlow
        expr: |
          (
            sum(rate(pipeline_step_duration_seconds_sum{status="success",step="ingest"}[10m]))
            /
            sum(rate(pipeline_step_duration_seconds_count{status="success",step="ingest"}[10m]))
          ) > 2
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "LangGraph pilot ingest step slow"
          description: "Average ingest step duration >2s over the last 10m. Investigate upstream provider latency or local bottlenecks."

      - alert: LanggraphPilotTotalDurationSlowByOrchestrator
        expr: |
          (
            sum(rate(pipeline_total_duration_seconds_sum{status="success"}[10m])) by (orchestrator)
            /
            sum(rate(pipeline_total_duration_seconds_count{status="success"}[10m])) by (orchestrator)
          ) > 6
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "LangGraph pilot total duration slow (by orchestrator)"
          description: "Average pilot total duration >6s over the last 10m grouped by orchestrator."

      - alert: LanggraphPilotHighErrorRatioByOrchestrator
        expr: |
          (
            sum(rate(pipeline_total_duration_seconds_count{status="error"}[10m])) by (orchestrator)
            /
            sum(rate(pipeline_total_duration_seconds_count[10m])) by (orchestrator)
          ) > 0.05
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "LangGraph pilot high error ratio (by orchestrator)"
          description: "More than 5% of pilot runs are erroring over the last 10 minutes for a specific orchestrator."

      - alert: LanggraphPilotInflightHigh
        expr: |
          sum(pipeline_inflight) by (tenant,workspace) > 10
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "LangGraph pilot inflight high"
          description: "Inflight pilot runs exceed 10 for 10m; investigate backlog or stuck runs."

      - alert: LanggraphPilotStepFailureRatioHigh
        expr: |
          (
            sum(rate(pipeline_steps_failed_total[10m])) by (step)
            /
            (
              sum(rate(pipeline_steps_failed_total[10m])) by (step)
              + sum(rate(pipeline_steps_completed_total[10m])) by (step)
            )
          ) > 0.2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "LangGraph pilot high step failure ratio"
          description: "Step failure ratio exceeds 20% over the last 10 minutes."

      - alert: LanggraphPilotTotalDurationP95High
        expr: |
          histogram_quantile(
            0.95,
            sum by (le, orchestrator) (rate(pipeline_total_duration_seconds_bucket{status="success"}[10m]))
          ) > 8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "LangGraph pilot p95 total duration high"
          description: "p95 of total pilot duration exceeds 8s over the last 10m (by orchestrator)."

      - alert: CostSpikeWithLowCache
        expr: |
          (
            (sum(rate(llm_estimated_cost_usd_sum[10m])) / sum(rate(llm_estimated_cost_usd_count[10m]))) > 0.05
          )
          and
          (
            avg_over_time(semantic_cache_shadow_hit_ratio[10m]) < 0.1
          )
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Cost spike with low semantic cache effectiveness"
          description: "Average cost > $0.05 per call while shadow hit ratio < 10% over 10m."
