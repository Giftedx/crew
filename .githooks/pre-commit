#!/bin/bash
# Pre-commit hook for Ultimate Discord Intelligence Bot
# Ensures code quality and prevents common issues

set -e

echo "ğŸ” Running pre-commit quality checks..."

# Check if we're in the right directory
if [ ! -f "pyproject.toml" ]; then
    echo "âŒ Error: Not in project root directory"
    exit 1
fi

# Ensure virtual environment is active
if [ -z "$VIRTUAL_ENV" ] && [ ! -f ".venv/bin/python" ]; then
    echo "âš ï¸  Warning: No virtual environment detected"
    echo "   Run: python -m venv .venv && source .venv/bin/activate"
fi

# Use Python from virtual environment if available
PYTHON="python"
if [ -f ".venv/bin/python" ]; then
    PYTHON=".venv/bin/python"
fi

echo "ğŸ¨ Formatting code..."
if ! make format; then
    echo "âŒ Code formatting failed"
    exit 1
fi

echo "ğŸ” Running lints..."
if ! make lint; then
    echo "âŒ Linting failed"
    exit 1
fi

echo "ğŸ§ª Running fast tests..."
if ! make test-fast; then
    echo "âŒ Fast tests failed"
    exit 1
fi

echo "ğŸ”§ Running compliance checks..."
if command -v "$PYTHON" >/dev/null 2>&1; then
    # Check for direct requests usage
    if grep -r "import requests" src/ --include="*.py" | grep -v "http_utils.py" | grep -v "# type: ignore" >/dev/null 2>&1; then
        echo "âŒ Found direct requests import (use core.http_utils)"
        grep -r "import requests" src/ --include="*.py" | grep -v "http_utils.py" | grep -v "# type: ignore"
        exit 1
    fi

    # Check for missing StepResult usage in tools
    if find src/ultimate_discord_intelligence_bot/tools/ -name "*.py" -not -name "_base.py" -not -name "__init__.py" -exec grep -l "def _run" {} \; | xargs grep -L "StepResult" 2>/dev/null; then
        echo "âš ï¸  Warning: Some tools may not be using StepResult pattern"
    fi
fi

echo "âœ… All pre-commit checks passed!"
echo "ğŸ“ Remember to run 'make type' before pushing for type checking"
