#!/bin/bash
# Pre-commit hook for Ultimate Discord Intelligence Bot
# Ensures code quality and prevents common issues

set -e

echo "ğŸ” Running pre-commit quality checks..."

# Check if we're in the right directory
if [ ! -f "pyproject.toml" ]; then
    echo "âŒ Error: Not in project root directory"
    exit 1
fi

# Ensure virtual environment is active
if [ -z "$VIRTUAL_ENV" ] && [ ! -f ".venv/bin/python" ]; then
    echo "âš ï¸  Warning: No virtual environment detected"
    echo "   Run: python -m venv .venv && source .venv/bin/activate"
fi

# Use Python from virtual environment if available
PYTHON="python"
if [ -f ".venv/bin/python" ]; then
    PYTHON=".venv/bin/python"
fi

echo "ğŸ¨ Formatting code..."
if ! make format; then
    echo "âŒ Code formatting failed"
    exit 1
fi

echo "ğŸ” Running lints..."
if ! make lint; then
    echo "âŒ Linting failed"
    exit 1
fi

echo "ğŸ§ª Running fast tests..."
if [ "${RUN_PRECOMMIT_TESTS:-0}" != "1" ]; then
    echo "âš ï¸  Skipping fast tests by default (set RUN_PRECOMMIT_TESTS=1 to enable)."
    echo "   Tip: run 'make test-fast' locally when deps are installed."
else
    if ! make test-fast; then
        echo "âŒ Fast tests failed"
        exit 1
    fi
fi

echo "ğŸ”§ Running compliance checks..."
if command -v "$PYTHON" >/dev/null 2>&1; then
    # StepResult usage advisory (informational only; enforced by repo scripts and tests)
    if find src/ultimate_discord_intelligence_bot/tools/ -name "*.py" -not -name "_base.py" -not -name "__init__.py" -exec grep -l "def _run" {} \; | xargs grep -L "StepResult" 2>/dev/null; then
        echo "âš ï¸  Warning: Some tools may not be using StepResult pattern"
    fi
fi

echo "âœ… All pre-commit checks passed!"
echo "ğŸ“ Remember to run 'make type' before pushing for type checking"
