#!/bin/bash
# Pre-commit hook for Ultimate Discord Intelligence Bot
# Ensures code quality and prevents common issues

set -e

echo "ğŸ” Running pre-commit quality checks..."

# Check if we're in the right directory
if [ ! -f "pyproject.toml" ]; then
    echo "âŒ Error: Not in project root directory"
    exit 1
fi

# Ensure virtual environment is active
if [ -z "$VIRTUAL_ENV" ] && [ ! -f ".venv/bin/python" ]; then
    echo "âš ï¸  Warning: No virtual environment detected"
    echo "   Run: python -m venv .venv && source .venv/bin/activate"
fi

# Use Python from virtual environment if available
PYTHON="python"
if [ -f ".venv/bin/python" ]; then
    PYTHON=".venv/bin/python"
fi

echo "ğŸ¨ Formatting code..."
if ! make format; then
    echo "âŒ Code formatting failed"
    exit 1
fi

echo "ğŸ” Running lints..."
if ! make lint; then
    echo "âŒ Linting failed"
    exit 1
fi

echo "ğŸ§ª Running fast tests..."
if ! make test-fast; then
    echo "âŒ Fast tests failed"
    exit 1
fi

echo "ğŸ”§ Running compliance guards..."
if command -v "$PYTHON" >/dev/null 2>&1; then
    guards_passed=true

    # HTTP wrapper usage validation
    if ! "$PYTHON" scripts/validate_http_wrappers_usage.py; then
        echo "âŒ HTTP wrapper guard failed (use http_utils, not direct requests.*)"
        guards_passed=false
    fi

    # Tools exports validation
    if ! "$PYTHON" scripts/validate_tools_exports.py; then
        echo "âŒ Tools export guard failed"
        guards_passed=false
    fi

    # Metrics instrumentation validation
    if ! "$PYTHON" scripts/metrics_instrumentation_guard.py; then
        echo "âŒ Metrics instrumentation guard failed"
        guards_passed=false
    fi

    # Deprecated directories validation
    if ! "$PYTHON" scripts/guards/deprecated_directories_guard.py; then
        echo "âŒ Deprecated directories guard failed"
        guards_passed=false
    fi

    # Dispatcher usage validation (optional)
    if ! "$PYTHON" scripts/validate_dispatcher_usage.py 2>/dev/null; then
        echo "âš ï¸  Warning: Dispatcher usage guard skipped (optional)"
    fi

    if [ "$guards_passed" = false ]; then
        echo ""
        echo "âŒ Compliance guards failed!"
        echo "Fix violations or bypass with: git commit --no-verify (emergencies only)"
        echo "Run 'make guards' for detailed output"
        exit 1
    fi
fi

echo "âœ… All pre-commit checks passed!"
echo "ğŸ“ Remember to run 'make type' before pushing for type checking"
