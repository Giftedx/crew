## AI Agent Guide

- **Runtime surfaces**: Launch Discord/crew via `python -m ultimate_discord_intelligence_bot.setup_cli run {discord|crew}` (enhanced flags: `make run-discord-enhanced`); API is built in `src/server/app.py`; optional MCP entrypoint sits under `mcp_server/`.
- **FastAPI wiring**: `create_app()` layers CORS → metrics → API cache → Prometheus `/metrics` → rate limiting; keep `/metrics` and `/health` outside rate-limit/tenant guards.
- **Pipeline flow**: `ContentPipeline` (`pipeline_components/orchestrator.py`) executes download → transcription → content routing → quality gate → analysis/finalization; each phase returns a `StepResult` so fan-out tasks cancel cleanly on first failure.
- **StepResult discipline**: Prefer `StepResult.ok/skip/uncertain/with_context` and populate `error_category`, `ErrorContext`, and `metadata` so `_pipeline_context` can score retries, severity, and observability.
- **Tenancy & namespaces**: Use `with_tenant(...)`, `current_tenant()`, and `mem_ns()` (`tenancy/__init__.py`) when touching storage, caches, or metrics; tenant configs live under `tenants/<slug>` and are created by the setup CLI.
- **LLM routing & budgeting**: `services/openrouter_service.py` orchestrates contextual bandits under `src/ai/`, tracks spend with `TokenMeter`, and consults semantic caches in `cache/semantic/`; respect `ENABLE_SEMANTIC_CACHE*` when adding new calls.
- **Tool pattern**: Subclass `tools/_base.BaseTool`, register module paths in `tools/__init__.py::MAPPING`, export in `__all__`, and increment `obs.metrics.get_metrics().counter("tool_runs_total", labels={...})` inside `run()` implementations.
- **Content routing**: `ContentTypeRoutingTool` feeds classifications into `config/content_types.yaml`; fall back to env thresholds (`QUALITY_MIN_*`) just like the orchestrator.
- **Caching direction**: Follow `docs/architecture/adr-0001-cache-platform.md`; prefer `core/cache/multi_level_cache.py` adapters and document new flags with `make docs-flags-write`.
- **HTTP access**: All outbound HTTP goes through `core/http_utils.resilient_get/resilient_post/retrying_*`; `scripts/validate_http_wrappers_usage.py` blocks raw `requests.*` usage.
- **Downloads**: Reuse `tools/multi_platform_download_tool.MultiPlatformDownloadTool`; never invoke `yt-dlp` via subprocess—`make guards` enforces this guardrail.
- **Memory integration**: Obtain vector clients via `memory/qdrant_provider.get_qdrant_client()`; it returns a pooled client or dummy in tests, so avoid instantiating `QdrantClient` directly.
- **Observability**: Emit counters/histograms via `obs.metrics`, tag spans with tenant/workspace/content type using `pipeline_components/tracing.py`, and ensure long-running tasks publish notes via `BaseTool.publish_message` when available.
- **Secrets & policy**: Resolve secrets through `core.secure_config.get_config()` and `security/secrets.get_secret`; keep tenant policy overrides in `tenants/<slug>/policy_overrides.yaml` aligned with feature flags and routing limits.
- **Feature flags & settings**: `src/core/settings.py` provides the lightweight env overlay; `core/secure_config.get_config()` exposes secrets/flags for tools and pipeline; mirror new toggles in docs with `make docs-flags-write`.
- **Guarded directories**: `scripts/guards/deprecated_directories_guard.py` forbids new code in `core/routing/`, `ai/routing/`, and `performance/`; add features under `ultimate_discord_intelligence_bot/` instead.
- **Developer bootstrap**: Run `make init-env`, then `make first-run` (prefers `uv`) or `python -m ultimate_discord_intelligence_bot.setup_cli wizard`; `make doctor` verifies environment/tenant wiring.
- **Daily loop**: Use `make quick-check` (format + lint + test-fast), `make guards` after editing networking/tools, `make compliance` for HTTP/StepResult audits, and `scripts/dev-workflow.sh full-check` for CI parity.
- **Testing**: Execute `PYTHONPATH=src pytest -q -c .config/pytest.ini`; targeted sweeps live behind `make test-fast`, `make test-a2a`, `make test-mcp`, and `make compliance-summary` for reporting.
- **Compliance & docs**: `make compliance-fix` auto-remediates common findings; `make docs`/`docs-strict` validate dashboards + feature-flag docs; `make deprecations-badge` refreshes README metadata.
- **Data surfaces**: Runtime artifacts land under `crew_data/` (Downloads/Logs/Processing) and archival outputs under `archive/` + `benchmarks/`; ensure new pipelines respect these directories to keep tooling operational.
- **Runbooks & references**: Keep `docs/core_services.md`, `docs/ARCHITECTURE_SYNC_REPORT_*.md`, and `docs/dev_assistants/*.md` nearby when wiring cross-service integrations or tracing data flows.
