name: Compliance Guards CI

on:
    pull_request:
        types: [opened, synchronize, reopened]
    push:
        branches: [main, master, develop]
    workflow_dispatch:

jobs:
    compliance-guards:
        name: Run Compliance Guards
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Full history for git-based guards

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Cache pip dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-guards-${{ hashFiles('**/pyproject.toml') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-guards-
                      ${{ runner.os }}-pip-

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  python -m pip install -e .[dev]

            - name: Run all compliance guards
              id: guards
              run: |
                  set -o pipefail
                  make guards 2>&1 | tee guards_output.log
              continue-on-error: true

            - name: Generate guard violation report
              if: always()
              run: |
                  mkdir -p reports
                  python scripts/generate_guard_report.py --input guards_output.log --output reports/guard_violations.json || echo "Guard report generation skipped (script not yet implemented)"

            - name: Upload guard violation report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: guard-violations-report
                  path: |
                      guards_output.log
                      reports/guard_violations.json
                  retention-days: 30

            - name: Comment PR with violations (if any)
              if: failure() && github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const logContent = fs.readFileSync('guards_output.log', 'utf8');
                      const body = `## ⚠️ Compliance Guard Violations Detected

                      The compliance guards have detected violations that must be fixed before merging.

                      <details>
                      <summary>View Guard Output</summary>

                      \`\`\`
                      ${logContent.substring(0, 60000)}
                      \`\`\`

                      </details>

                      **Action Required:**
                      1. Review the violations above
                      2. Fix the issues locally
                      3. Run \`make guards\` to verify fixes
                      4. Push your changes

                      See [Compliance Guards Documentation](../docs/compliance-guards.md) for more details.
                      `;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: body
                      });

            - name: Fail workflow if guards failed
              if: steps.guards.outcome == 'failure'
              run: |
                  echo "❌ Compliance guards failed. Please fix the violations and try again."
                  exit 1

            - name: Success summary
              if: success()
              run: |
                  echo "✅ All compliance guards passed!"
                  echo ""
                  echo "Guards validated:"
                  echo "  ✅ HTTP wrapper usage (no direct requests.* calls)"
                  echo "  ✅ Tools exports (all tools in __all__)"
                  echo "  ✅ Metrics instrumentation (proper metric naming)"
                  echo "  ✅ Dispatcher usage (no direct DispatcherPoolExecutor)"
                  echo "  ✅ Deprecated directories (no new modules in restricted paths)"
